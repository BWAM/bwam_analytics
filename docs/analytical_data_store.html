<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Zachary M. Smith">
<title>BWAM Analytics - 3&nbsp; Analytical Data Store</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./generate_parquet_files.html" rel="next">
<link href="./wqma_oracle_db.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analytical_data_store.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Analytical Data Store</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">BWAM Analytics</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/BWAM/bwam_analytics" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Landing Page</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wqma_oracle_db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">WQMA Oracle Data Warehouse</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analytical_data_store.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Analytical Data Store</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generate_parquet_files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Generate Parquet Files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_dictionary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Dictionary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#just-give-me-the-data" id="toc-just-give-me-the-data" class="nav-link active" data-scroll-target="#just-give-me-the-data"><span class="header-section-number">3.0.1</span> Just Give Me the Data</a></li>
  <li><a href="#parquet-and-arrow-introduction" id="toc-parquet-and-arrow-introduction" class="nav-link" data-scroll-target="#parquet-and-arrow-introduction"><span class="header-section-number">3.1</span> Parquet and Arrow Introduction</a></li>
  <li><a href="#query-overview" id="toc-query-overview" class="nav-link" data-scroll-target="#query-overview"><span class="header-section-number">3.2</span> Query Overview</a></li>
  <li>
<a href="#common-queries" id="toc-common-queries" class="nav-link" data-scroll-target="#common-queries"><span class="header-section-number">3.3</span> Common Queries</a>
  <ul class="collapse">
<li><a href="#waterbody-data-from-a-specific-time-period" id="toc-waterbody-data-from-a-specific-time-period" class="nav-link" data-scroll-target="#waterbody-data-from-a-specific-time-period"><span class="header-section-number">3.3.1</span> Waterbody Data from a Specific Time Period</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/BWAM/bwam_analytics/edit/main/analytical_data_store.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/BWAM/bwam_analytics/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Analytical Data Store</span>
</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zachary M. Smith </p>
          </div>
  </div>
    
  
    
  </div>
  


</header><p>The goal of Analytical Data Store is to provide a simple and fast way to access BWAM water quality data.</p>
<p>Data from the BWAM Oracle Data Warehouse, Water Quality Monitoring and Assessment (WQMA), have been extracted, collapsed into a two large tables, and saved as a <a href="https://parquet.apache.org/docs/overview/">parquet files</a>. The two tables represent:</p>
<ol type="1">
<li><p><u><strong>obt_taxa_abundance.parquet:</strong></u> All the taxonomic count data and associated sample information.</p></li>
<li><p><u><strong>obt_results.parquet:</strong></u> All results (e.g., chemistry, habitat, survey questions, etc.) and associated sample information.</p></li>
</ol>
<p>We will use the packages <a href="https://arrow.apache.org/docs/r/"><code>arrow</code></a> to connect to the parquet file and <a href="https://dplyr.tidyverse.org/index.html"><code>dplyr</code></a> to help us query data.</p>
<p>Let’s load the necessary packages and establish the file path to the <code>results</code> parquet file. The parquet file is stored on the L-drive and should be accessible to all DOW staff.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'arrow'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    timestamp</code></pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Directories</span></span>
<span><span class="va">obt_result_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span></span>
<span>  <span class="st">"L:"</span>,</span>
<span>  <span class="st">"DOW"</span>,</span>
<span>  <span class="st">"BWAM Share"</span>,</span>
<span>  <span class="st">"data"</span>,</span>
<span>  <span class="st">"parquet"</span>,</span>
<span>  <span class="st">"analytical_table_store"</span>,</span>
<span>  <span class="st">"obt_result.parquet"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">obt_taxa_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span></span>
<span>  <span class="st">"L:"</span>,</span>
<span>  <span class="st">"DOW"</span>,</span>
<span>  <span class="st">"BWAM Share"</span>,</span>
<span>  <span class="st">"data"</span>,</span>
<span>  <span class="st">"parquet"</span>,</span>
<span>  <span class="st">"analytical_table_store"</span>,</span>
<span>  <span class="st">"obt_taxa_abundance.parquet"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="just-give-me-the-data" class="level3" data-number="3.0.1"><h3 data-number="3.0.1" class="anchored" data-anchor-id="just-give-me-the-data">
<span class="header-section-number">3.0.1</span> Just Give Me the Data</h3>
<p>Some example queries provided to get you started quickly…</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># All data</span></span>
<span><span class="va">all_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># All lake data</span></span>
<span><span class="va">lake_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"lake"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># All TP results</span></span>
<span><span class="va">tp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMETER_NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"phosphorus"</span>,</span>
<span>         <span class="va">FRACTION</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"total"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">SITE_CODE</span>,</span>
<span>         <span class="va">EVENT_ID</span>,</span>
<span>         <span class="va">EVENT_DATETIME</span>,</span>
<span>         <span class="va">FRACTION</span>,</span>
<span>         <span class="va">PARAMETER_NAME</span>,</span>
<span>         <span class="va">RESULT_VALUE</span>,</span>
<span>         <span class="va">UNIT</span>,</span>
<span>         <span class="va">RESULT_QUALIFIER</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Count of the number of sites with chloride data by waterbody type</span></span>
<span><span class="va">cl_count_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMETER_NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"chloride"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/distinct.html">distinct</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span>, <span class="va">SITE_CODE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/count.html">count</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="parquet-and-arrow-introduction" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="parquet-and-arrow-introduction">
<span class="header-section-number">3.1</span> Parquet and Arrow Introduction</h2>
<blockquote class="blockquote">
<p>Apache Parquet is an open source, column-oriented data file format designed for efficient data storage and retrieval. it provides high performance compression and encoding schemes to handle complex data in bulk and is supported in many programming language and analtyics tools.</p>
<p>-<a href="https://parquet.apache.org/">Parquet (apache.org)</a></p>
</blockquote>
<p>As described above, parquet files are designed for efficient data retrieval. The data are stored in a columnar format, enabling rapid data retrievals. Using Apache Arrow, analytics can be performed in-memory (using RAM) on parquet files without the need to pull of the data into R or python. In general, this means queries can be performed very rapidly and you only load data you need into R or python.</p>
<p>Additionally, parquet files have meta data that describe the column types (character, numeric, date, etc.). Unlike, column separated values (CSVs) or excel file (XLSX), there is no need to tell R or python what the data type of data are stored in each column. This enables users to query data and begin working with it immediately with out the overhead of specifying column type details with every new analysis.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more information about Apache Parquet or Arrow, please visit:</p>
<ul>
<li><p>Parquet (apache.org)</p></li>
<li><p>Apache Arrow | Apache Arrow</p></li>
</ul>
</div>
</div>
</section><section id="query-overview" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="query-overview">
<span class="header-section-number">3.2</span> Query Overview</h2>
<p>Parquet files can be queried using the python library, <a href="https://arrow.apache.org/docs/python/index.html"><code>PyArrow</code></a>, or the R package, <a href="https://arrow.apache.org/docs/r/index.html"><code>arrow</code></a>. The remainder of this chapter will focus on using the R package, <code>arrow</code>.</p>
<p>Querying data is very similar to reading CSV files with <code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>, but it is a two step process:</p>
<ol type="1">
<li><p>Connect to the parquet file using the <code>arrow</code> function, <code><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset()</a></code></p></li>
<li><p>Read data into R, using the <code>dplyr</code> function, <code><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect()</a></code></p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">obt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Although it is not recommended for these data stores, you can use the <code>arrow</code> function, <a href="https://arrow.apache.org/docs/r/reference/read_parquet.html"><code>read_parquet()</code></a>, to perform the above query in a single step. This is not recommended, because in almost all instances you do not need all data in a data store for your analysis.</p>
</div>
</div>
<p>The <code><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset()</a></code> function can be followed by <code>dplyr</code> functions to query and perform analytics on the data store before bringing the data into R.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>arrow</code> supports many <code>dplyr</code> functions, but not all. If a <code>dplyr</code> function is not support, do as much of the work as you can with <code>arrow</code>, <code><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect()</a></code> the data into R, and then use the <code>dplyr</code> function of interest.</p>
</div>
</div>
<p>Let’s say we are interested in the major drainage basin names for basin numbers “01” and “02.” We can get to this information with the following query and we only need to load a 2x2 table into R as opposed to a 2,148,847x88 table.</p>
<ol type="1">
<li><p>Connect to the result data store.</p></li>
<li><p>Limit the data to only the columns <code>BASIN</code> and <code>BASIN_NAME</code> and remove duplicates.</p></li>
<li><p>Subset the rows to only those rows where <code>BASIN</code> is either “01” or “02.”</p></li>
<li><p>Load the queried data into R.</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/distinct.html">distinct</a></span><span class="op">(</span><span class="va">BASIN</span>, <span class="va">BASIN_NAME</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">BASIN</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 3</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  BASIN BASIN_NAME                   
  &lt;chr&gt; &lt;chr&gt;                        
1 01    Lake Erie-Niagara River Basin
2 02    Allegheny River Basin        </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When performing analytics, you must be cognizant of duplicates. These data sets have been denormalized – meaning some data have been made redundant due to a one-to-many join.</p>
<p>Use the dplyr functions, <a href="https://dplyr.tidyverse.org/reference/select.html"><code>select()</code></a> and <a href="https://dplyr.tidyverse.org/reference/distinct.html"><code>distinct()</code></a>, to help you target only the columns of interest and remove redundant rows before performing analytics.</p>
</div>
</div>
<p>You can also perform analytical summaries of the data store. Let’s say you are interested in the number of sites (<code>SITE_CODE</code>) that have total phosphorus data by waterbody type (<code>WATERBODY_TYPE)</code>. The following query limits the data to the rows and columns of interest and counts the number of sties in each waterbody type.</p>
<ol type="1">
<li><p>Connect to the result data store.</p></li>
<li>
<p>Subset the rows to only the rows where:</p>
<ul>
<li><p><code>PARAMETER_NAME</code> matches “phosphorus”</p></li>
<li><p><code>FRACTION</code> matches “total”</p></li>
</ul>
</li>
<li><p>Keep only the columns <code>WATERBODY_TYPE</code> and <code>SITE_CODE</code>, and remove any duplicate rows.</p></li>
<li><p>Aggregate by <code>WATERBODY_TYPE</code> and count the number of rows.</p></li>
<li><p>Load the queried data into R.</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMETER_NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"phosphorus"</span>, <span class="co"># 2</span></span>
<span>         <span class="va">FRACTION</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"total"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 3</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/distinct.html">distinct</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span>, <span class="va">SITE_CODE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 4</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/count.html">count</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 5</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  WATERBODY_TYPE     n
  &lt;chr&gt;          &lt;int&gt;
1 lake            1349
2 river_stream    1376
3 other              1
4 outfall            2</code></pre>
</div>
</div>
<p>Or maybe you are interested in finding the average and standard deviation of total phosphorus observations in each waterbody type:</p>
<ol type="1">
<li><p>Connect to the result data store.</p></li>
<li>
<p>Subset the rows to only the rows where:</p>
<ul>
<li><p><code>PARAMETER_NAME</code> matches “phosphorus”</p></li>
<li><p><code>FRACTION</code> matches “total”</p></li>
</ul>
</li>
<li><p>Keep only the columns <code>WATERBODY_TYPE</code>, <code>SITE_CODE</code>, <code>EVENT_ID</code>, and <code>RESULT_VALUE</code> and remove any duplicate rows.</p></li>
<li><p>Aggregate by <code>WATERBODY_TYPE</code>.</p></li>
<li><p>Perform summary statistics removing <code>NA</code> results (<strong>see warning note below</strong>).</p></li>
<li><p>Remove the aggregate/grouping from the data.</p></li>
<li><p>Load the queried data into R.</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMETER_NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"phosphorus"</span>, <span class="co"># 2</span></span>
<span>         <span class="va">FRACTION</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"total"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/distinct.html">distinct</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span>, <span class="va">SITE_CODE</span>, <span class="va">EVENT_ID</span>, <span class="va">RESULT_VALUE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 3</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">WATERBODY_TYPE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 4</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span> <span class="co"># 5</span></span>
<span>    MEAN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">RESULT_VALUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">RESULT_VALUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># 6</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  WATERBODY_TYPE   MEAN     SD
  &lt;chr&gt;           &lt;dbl&gt;  &lt;dbl&gt;
1 lake           0.0391  0.173
2 river_stream   0.0601  0.149
3 other          0.59   NA    
4 outfall        1.39    1.46 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that the query above excludes non-detects using the <code>na.rm = TRUE</code> argument in the <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> and <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code> calls. Therefore, the results are biased positively. If you are interested in a similar query, you need to decide how to handle non-detects and implement the decision prior to performing the summary statistics.</p>
</div>
</div>
</section><section id="common-queries" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="common-queries">
<span class="header-section-number">3.3</span> Common Queries</h2>
<section id="waterbody-data-from-a-specific-time-period" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="waterbody-data-from-a-specific-time-period">
<span class="header-section-number">3.3.1</span> Waterbody Data from a Specific Time Period</h3>
<p>What data were collected in Otsego Lake from 2022-2023?</p>
<ol type="1">
<li><p>Connect to the result data store.</p></li>
<li>
<p>Subset the rows to only the rows where:</p>
<ol type="1">
<li><p>The waterbody name is “Otsego Lake”</p></li>
<li><p>The sampling date is between 2022 and 2023</p></li>
</ol>
</li>
<li><p>Load the queried data into R.</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">otsego_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arrow/man/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">obt_result_dir</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">WATERBODY_NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"Otsego Lake"</span>, <span class="co"># 2.1</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/between.html">between</a></span><span class="op">(</span><span class="va">EVENT_DATETIME</span>, <span class="co"># 2.2</span></span>
<span>                 left <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span>,</span>
<span>                 right <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2023-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./wqma_oracle_db.html" class="pagination-link" aria-label="WQMA Oracle Data Warehouse">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">WQMA Oracle Data Warehouse</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./generate_parquet_files.html" class="pagination-link" aria-label="Generate Parquet Files">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Generate Parquet Files</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/BWAM/bwam_analytics/edit/main/analytical_data_store.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/BWAM/bwam_analytics/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>